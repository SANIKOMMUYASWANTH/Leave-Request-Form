<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leave Request</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 30px 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .header { text-align: center; margin-bottom: 30px; }
        h1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 28px; }
        .form-group { margin-bottom: 22px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #334155; }
        input, select, textarea { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; }
        .radio-group { display: flex; gap: 12px; margin-top: 10px; }
        .radio-label { flex: 1; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.3s; }
        input[type="radio"]:checked + .radio-label { background: #667eea; color: white; border-color: #667eea; }
        input[type="radio"] { display: none; }
        .alternative-resources { background: #f8fafc; padding: 20px; border-radius: 14px; display: none; border: 2px solid #e2e8f0; margin-top: 18px; }
        .alternative-resources.show { display: block; }
        .resource-entry { background: white; padding: 18px; border-radius: 10px; border: 2px solid #e2e8f0; margin-bottom: 14px; }
        .submit-btn { background: #10b981; color: white; border: none; padding: 16px; border-radius: 10px; width: 100%; font-weight: 600; cursor: pointer; margin-top: 20px; }
        .error-text { color: #ef4444; font-size: 12px; margin-top: 4px; display: none; }
        .show { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Leave Request</h1>
            <p style="color: #64748b;">Submit your application details</p>
        </div>
        
        <div id="loadingMessage" style="text-align: center; padding: 20px;">Loading employee list...</div>
        
        <form id="timeOffForm" style="display: none;">
            <div class="form-group">
                <label>Employee Name *</label>
                <select id="empName" required><option value="">Select your name</option></select>
            </div>
            
            <div class="form-group">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                    <div><label>Start Date *</label><input type="date" id="startDate" required></div>
                    <div><label>End Date *</label><input type="date" id="endDate" required></div>
                </div>
            </div>

            <div class="form-group">
                <label>Number of Days</label>
                <input type="text" id="numDays" readonly style="background: #f1f5f9;">
            </div>

            <div class="form-group">
                <label>Leave Type *</label>
                <select id="leaveType" required>
                    <option value="">Select leave type</option>
                    <option value="Earned Leave">Earned Leave</option>
                    <option value="Sick Leave">Sick Leave</option>
                    <option value="Compensatory Off">Compensatory Off</option>
                </select>
            </div>

            <div class="form-group">
                <label>Screenshot *</label>
                <input type="file" id="screenshot" accept="image/*" required>
            </div>

            <div class="form-group">
                <label>Working in shifts? *</label>
                <div class="radio-group">
                    <input type="radio" id="shiftsYes" name="inShifts" value="yes">
                    <label for="shiftsYes" class="radio-label">Yes</label>
                    <input type="radio" id="shiftsNo" name="inShifts" value="no">
                    <label for="shiftsNo" class="radio-label">No</label>
                </div>
            </div>

            <div id="alternativeResources" class="alternative-resources">
                <div id="resourcesContainer"></div>
                <button type="button" id="addResourceBtn" style="padding: 10px; width: 100%; cursor: pointer;">+ Add Alternative</button>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">Submit Request</button>
        </form>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGTaeoGfQkNksjVpTPZn-pgNqfDBdn4pfEp5qfPf9GDxqyoa0rFM5TaQK6tQdqVq__3Q/exec';
        let employeeList = [];
        let selectedAlternatives = new Set();
        let resourceCount = 0;

        const empNameSelect = document.getElementById('empName');
        const resourcesContainer = document.getElementById('resourcesContainer');

        async function loadEmployeeList() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=getEmployees');
                const data = await response.json();
                employeeList = data.employees;
                employeeList.forEach(emp => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = emp;
                    empNameSelect.appendChild(opt);
                });
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('timeOffForm').style.display = 'block';
            } catch (e) { console.error(e); }
        }

        // FIXED: Dropdown logic to prevent selection loss
        function populateAlternativeDropdown(selectElement, excludeName) {
            const currentValue = selectElement.value;
            const available = employeeList.filter(emp => 
                emp !== excludeName && (!selectedAlternatives.has(emp) || emp === currentValue)
            );
            
            let html = '<option value="">Select employee</option>';
            available.forEach(emp => {
                html += `<option value="${emp}" ${emp === currentValue ? 'selected' : ''}>${emp}</option>`;
            });
            selectElement.innerHTML = html;
        }

        function updateAllAlternativeDropdowns(activeId) {
            const requester = empNameSelect.value;
            document.querySelectorAll('select[name="altResourceName[]"]').forEach(select => {
                if (select.dataset.resourceId !== activeId) {
                    populateAlternativeDropdown(select, requester);
                }
            });
        }

        document.getElementById('addResourceBtn').onclick = () => {
            resourceCount++;
            const div = document.createElement('div');
            div.className = 'resource-entry';
            div.innerHTML = `
                <label>Shift Date *</label><input type="date" name="shiftDate[]" required>
                <label>Alternative Name *</label>
                <select name="altResourceName[]" data-resource-id="${resourceCount}" required></select>
                <label>Shift Type *</label>
                <select name="shiftType[]" required>
                    <option value="First Shift">First Shift</option>
                    <option value="Second Shift">Second Shift</option>
                </select>
            `;
            resourcesContainer.appendChild(div);
            const sel = div.querySelector('select[name="altResourceName[]"]');
            populateAlternativeDropdown(sel, empNameSelect.value);
            
            sel.onchange = function() {
                if (this.dataset.oldValue) selectedAlternatives.delete(this.dataset.oldValue);
                if (this.value) {
                    selectedAlternatives.add(this.value);
                    this.dataset.oldValue = this.value;
                }
                updateAllAlternativeDropdowns(this.dataset.resourceId);
            };
        };

        document.getElementById('shiftsYes').onchange = () => document.getElementById('alternativeResources').classList.add('show');
        document.getElementById('shiftsNo').onchange = () => {
            document.getElementById('alternativeResources').classList.remove('show');
            resourcesContainer.innerHTML = '';
            selectedAlternatives.clear();
        };

        document.getElementById('timeOffForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.textContent = 'Submitting...';
            
            const formData = {
                employeeName: empNameSelect.value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                numDays: document.getElementById('numDays').value,
                leaveType: document.getElementById('leaveType').value,
                inShifts: document.querySelector('input[name="inShifts"]:checked').value,
                alternativeResources: []
            };

            if (formData.inShifts === 'yes') {
                const dates = document.querySelectorAll('input[name="shiftDate[]"]');
                const names = document.querySelectorAll('select[name="altResourceName[]"]');
                const types = document.querySelectorAll('select[name="shiftType[]"]');
                dates.forEach((d, i) => {
                    formData.alternativeResources.push({shiftDate: d.value, alternativeName: names[i].value, shiftType: types[i].value});
                });
            }

            const file = document.getElementById('screenshot').files[0];
            const reader = new FileReader();
            reader.onload = async (ev) => {
                formData.screenshot = { data: ev.target.result.split(',')[1], name: file.name, mimeType: file.type };
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(formData) });
                alert('Success!'); location.reload();
            };
            reader.readAsDataURL(file);
        };

        loadEmployeeList();
    </script>
</body>
</html>
